<!DOCTYPE html>
<html>
<head lang="en">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content" />
    <meta name="HandheldFriendly" content="True">
    <title>Crossword Nexus Solver</title>

    <!-- Shared CSS -->
    <link rel="stylesheet" href="./css/crossword.shared.css">

    <!-- jQuery -->
    <script src="lib/jquery.js"></script>

    <!-- for loading crosswords -->
    <script src="lib/jscrossword_combined.js"></script>

    <!-- confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- GG animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" integrity="sha512-16esztaSRplJROstbIIdwX3N97V1+pZvV33ABoG1H2OyTttBxEGkTsoIVsiP1iaTtM8b3+hu2kB6pQ4Clr5yug==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
      /**
      * Parse URL query parameters and build a crossword configuration object.
      * Supports:
      *   ?puzzle= or ?file= → the puzzle file URL
      *   ?config= (base64 JSON) → additional options for the solver
      * Returns a normalized `params` object for CrosswordNexus.createCrossword().
      */
      function getCrosswordParams() {
        const url = new URL(window.location.href);

        // Accept both ?puzzle= and ?file= as synonyms for the puzzle URL
        const puzzle = url.searchParams.get("puzzle") || url.searchParams.get("file");

        // Optional Base64-encoded config JSON (e.g., layout or theming)
        const b64config = url.searchParams.get("config");

        // The object we'll pass to the crossword initializer
        const params = {};

        // If a puzzle URL was given, infer its file type from the extension
        if (puzzle) {
          params.puzzle_file = {
            url: puzzle,
            type: puzzle.slice(puzzle.lastIndexOf('.') + 1)
          };
        }

      // Decode and merge any additional Base64-encoded config options
      if (b64config) {
        try {
          Object.assign(params, JSON.parse(atob(b64config)));
        } catch (e) {
          console.warn("Invalid config parameter (could not decode Base64 JSON):", e);
        }
      }

      return params;
    }


        function isMobileDevice() {
          const ua = navigator.userAgent || '';
          const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 1;
          const isiPad = ua.includes("iPad") || (ua.includes("Mac") && navigator.maxTouchPoints > 1);
          const isMobileUA = /android|iphone|ipod|mobile/i.test(ua);
          //const isSmallScreen = Math.max(window.innerWidth, window.innerHeight) < 1024;

          return isTouch && (isMobileUA || isiPad);
        }

        const mobile = isMobileDevice();
        console.log('[Device Detection]', {
          ua: navigator.userAgent,
          platform: navigator.platform,
          maxTouchPoints: navigator.maxTouchPoints,
          isMobile: mobile
        });

        if (mobile) {
          // ✅ Load core engine first (crosswords.js)
          const core = document.createElement('script');
          core.src = './js/crosswords.js';

          core.onload = () => {
            // ✅ Then load mobile layout script and CSS
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = './css/crossword.mobile.css';
            document.head.appendChild(link);

            const mobileScript = document.createElement('script');
            mobileScript.src = './js/crossword.mobile.js';
            document.body.appendChild(mobileScript); // ✅ Let it handle its own init
          };

          window.addEventListener('DOMContentLoaded', () => {
            document.body.appendChild(core);
          });

        } else {
          // ✅ Desktop CSS
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = './css/crosswordnexus.css';
          document.head.appendChild(link);

          // ✅ Desktop JS + Init
          const script = document.createElement('script');
          script.src = './js/crosswords.js';
          script.onload = () => {
            console.log('[Desktop] crosswords.js loaded — initializing crossword');

            const params = getCrosswordParams();

            window.gCrossword = CrosswordNexus.createCrossword($('div.crossword'), params);

            setTimeout(() => {
              const svg = document.getElementById('cw-puzzle-grid');
              const cw = window.gCrossword;

              if (svg && cw?.renderCells && cw.grid_width && cw.grid_height) {
                console.log('[Fix] Final render pass after layout settle');
                cw.renderCells();
                cw.windowResized?.();
                cw.syncTopTextWidth?.();
              } else {
                console.warn('[Fix] Skipping renderCells — grid size not yet initialized', {
                  grid_width: cw?.grid_width,
                  grid_height: cw?.grid_height
                });
              }
            }, 350);
          };

          window.addEventListener('DOMContentLoaded', () => {
            document.body.appendChild(script);
          });
        }
      </script>

    <noscript>
      <link rel="stylesheet" href="./css/crosswordnexus.css">
    </noscript>

    <style>
        html, body {
            /* height: 100%; */
            margin: 0;
            background-color: white;
        }
        div.crossword { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
    </style>

    <!-- SUCCESS ANIMATION STYLES -->
    <style>
        html, body {
          height: 100dvh;
          overflow: hidden;
        }
        .crossword {
          height: 100%;
          display: flex;
          flex-direction: column;
        }
    </style>

</head>
<body>
    <div class="crossword crosswordnexus-theme"></div>

</body>
</html>
